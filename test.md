@startuml

actor 太郎
actor 花子
database シグナリングサーバ

== 初期化 ==

太郎 -> STUNサーバ: STUNサーバの設定をする
花子 -> STUNサーバ: 同上

太郎 -> 太郎: メディア(音声とビデオ)の使用を許可する
花子 -> 花子: 同上

太郎 -> 太郎: シグナリングサーバと通信をするための\nインスタンスを作成する
花子 -> 花子: 同上

太郎 -> 太郎: 自分の名前をアプリケーションに登録する
花子 -> 花子: 同上

太郎 -> シグナリングサーバ: シグナリングサーバをリスン(👀)する\nリスンするパスは自分の名前配下とする
花子 -> シグナリングサーバ: 同上

== offerの送受信 ==

太郎 -> 太郎: 相手の名前をアプリケーションに登録する
太郎 -> 太郎: 通信経路をシグナリングサーバに\n送信できるようにイベントハンドラを作成する
太郎 -> 太郎: P2P接続確立後、\n通信相手のメディアストリーム情報の受信後、\n表示先のDOMを登録しておく
太郎 -> 太郎: 太郎のSDPを作成し保存する
太郎 -> シグナリングサーバ: SDP(offer)を送信する。

花子 <- シグナリングサーバ: SDP(offer)を受信する。
花子 -> 花子: 相手の名前をアプリケーションに登録する
花子 -> 花子: 通信経路をシグナリングサーバに\n送信できるようにイベントハンドラを作成する
花子 -> 花子: P2P接続確立後、\n通信相手のメディアストリーム情報の受信後、\n表示先のDOMを登録しておく
花子 -> 花子: 太郎のSDPを保存する

== answerの送受信 ==

花子 -> 花子: 花子のSDPを作成し保存する
花子 -> シグナリングサーバ: SDP(answer)を送信する。
シグナリングサーバ -> 太郎: SDP(answer)を受信する。

太郎 -> 太郎: 花子のSDPを保存

== candidate(通信経路)の送受信を何度か行う ==

STUNサーバ -> 太郎: candidateを取得する。
STUNサーバ -> 花子: candidateを取得する。

太郎 -> シグナリングサーバ: candidateを転送する。
花子 <- シグナリングサーバ: candidateを転送する。
花子 <- 花子: 受信したcandidateを登録する。

花子 -> シグナリングサーバ: candidateを送信する。
太郎 <- シグナリングサーバ: candidateを受信する。
太郎 <- 太郎: 受信したcandidateを登録する。


note over 太郎, 花子
P2P接続確立
end note


太郎 <-> 花子: 音声とビデオの送受信
activate 太郎
activate 花子
太郎 <-> 花子: :
太郎 <-> 花子: :

@enduml
